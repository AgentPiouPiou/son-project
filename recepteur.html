<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<title>R√©cepteur d√©cimal temps r√©el</title>

<style>
body{
  font-family:Arial;
  max-width:900px;
  margin:auto;
}

canvas{
  width:100%;
  height:240px;
  border:1px solid #ccc;
}

.mono{
  font-family:monospace;
}
</style>
</head>

<body>

<h1>üéß R√©cepteur ultrasonique</h1>

<button onclick="start()">D√©marrer r√©ception</button>

<h3>Spectre temps r√©el</h3>
<canvas id="vizRx"></canvas>

<h3>Message</h3>
<p id="msg" class="mono"></p>

<script>

const audioCtx=new AudioContext();

const SYMBOL_FREQS=[
15000,16000,17000,18000,19000,
20000,21000,22000,23000,24000
];

const INIT_FREQ=14000;

let analyser;

async function start(){

  const stream=await navigator.mediaDevices.getUserMedia({
    audio:{
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  const source=audioCtx.createMediaStreamSource(stream);

  analyser=audioCtx.createAnalyser();
  analyser.fftSize=4096;

  source.connect(analyser);

  detectLoop();
  visualize();
}

/* ---------------- DETECTION ---------------- */

function energyAt(freq){

  const buffer=new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(buffer);

  const nyquist=audioCtx.sampleRate/2;

  const idx=Math.round((freq/nyquist)*buffer.length);

  let sum=0,n=0;

  for(let i=idx-2;i<=idx+2;i++){

    if(buffer[i]){
      sum+=buffer[i];
      n++;
    }
  }

  return n?sum/n:0;
}

let bufferMsg="";

function detectLoop(){

  const initEnergy=energyAt(INIT_FREQ);

  if(initEnergy>120){
    bufferMsg="";
  }

  let best=-1;
  let bestIdx=-1;

  SYMBOL_FREQS.forEach((f,i)=>{

    const e=energyAt(f);

    if(e>best){
      best=e;
      bestIdx=i;
    }
  });

  if(best>120 && bestIdx>=0){
    bufferMsg+=bestIdx.toString();
    document.getElementById("msg").textContent=bufferMsg;
  }

  requestAnimationFrame(detectLoop);
}

/* ---------------- VISUALISATION ---------------- */

function visualize(){

  const canvas=document.getElementById("vizRx");
  const ctx=canvas.getContext("2d");

  const buffer=new Uint8Array(analyser.frequencyBinCount);

  function draw(){

    analyser.getByteFrequencyData(buffer);

    ctx.fillStyle="white";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.beginPath();

    for(let i=0;i<buffer.length;i++){

      const x=i/buffer.length*canvas.width;
      const y=canvas.height-buffer[i];

      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }

    ctx.stroke();

    requestAnimationFrame(draw);
  }

  draw();
}

</script>

</body>
</html>
