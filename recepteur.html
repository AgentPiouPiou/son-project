<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Avancé</title>
</head>
<body>

<h2>Récepteur Avancé</h2>

<button onclick="demarrer()">Démarrer (3s calibration)</button>

<p id="status"></p>
<p id="texte"></p>

<script>

const BIT_DURATION = 110;

const FREQ = {
  3200: "00",
  3600: "01",
  4000: "10",
  4400: "11"
};

const START = 5000;
const END = 5500;

let audioCtx, analyser, stream;
let noiseLevel = 0;
let receiving = false;
let symbols = [];

async function demarrer(){

    document.getElementById("status").innerText =
        "Calibration...";

    stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    source.connect(analyser);

    const buffer = new Uint8Array(analyser.frequencyBinCount);

    let total = 0;
    let count = 0;
    const start = Date.now();

    while(Date.now() - start < 3000){
        analyser.getByteFrequencyData(buffer);
        total += Math.max(...buffer);
        count++;
    }

    noiseLevel = total / count + 10;

    document.getElementById("status").innerText =
        "Prêt";

    loop();
}

function getPeak(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let max = 0;
    let index = 0;

    for(let i=0;i<buffer.length;i++){
        if(buffer[i] > max){
            max = buffer[i];
            index = i;
        }
    }

    if(max < noiseLevel) return null;

    return index * audioCtx.sampleRate / analyser.fftSize;
}

function detectSymbol(freq){

    if(!freq) return null;

    for(let f in FREQ){
        if(Math.abs(freq - f) < 120){
            return FREQ[f];
        }
    }

    return null;
}

function loop(){

    const freq = getPeak();

    if(freq && Math.abs(freq - START) < 150){
        receiving = true;
        symbols = [];
        setTimeout(readSymbol, 1000);
    }

    requestAnimationFrame(loop);
}

function readSymbol(){

    if(!receiving) return;

    const samples = [];

    for(let i=0;i<3;i++){
        samples.push(detectSymbol(getPeak()));
    }

    const valid = samples.filter(s => s !== null);

    if(valid.length > 1){
        symbols.push(valid[0]);
    }

    const freq = getPeak();

    if(freq && Math.abs(freq - END) < 150){
        receiving = false;
        decode();
        return;
    }

    setTimeout(readSymbol, BIT_DURATION*2);
}

function decode(){

    let binary = symbols.join("");

    const data = binary.slice(0,-8);
    const crc = binary.slice(-8);

    let check = 0;
    for(let i=0;i<data.length;i++){
        check ^= parseInt(data[i]);
    }

    if(check.toString(2).padStart(8,"0") !== crc){
        document.getElementById("texte").innerText =
            "Erreur CRC (bruit détecté)";
        return;
    }

    let texte = "";

    for(let i=0;i<data.length;i+=8){
        const byte = data.slice(i,i+8);
        texte += String.fromCharCode(parseInt(byte,2));
    }

    document.getElementById("texte").innerText =
        "Reçu : " + texte;
}

</script>
</body>
</html>
