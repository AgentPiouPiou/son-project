<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Stable</title>
</head>
<body>

<h2>Récepteur</h2>

<button onclick="start()">Démarrer (Calibration 5s)</button>

<p id="affichage"></p>

<script>

const FREQ0 = 1200;
const FREQ1 = 5000;
const START = 7000;
const END = 9000;
const PREAMBLE = "11110000";

let audioCtx, analyser;
let noiseFloor = 0;

let receiving = false;
let bufferBits = "";
let finalText = "";

async function start(){

    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;

    source.connect(analyser);

    calibrateNoise();
}

function calibrateNoise(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);

    let total=0;
    let count=0;
    const start = Date.now();

    function measure(){

        analyser.getByteFrequencyData(buffer);

        total += Math.max(...buffer);
        count++;

        if(Date.now()-start < 5000){
            requestAnimationFrame(measure);
        }
        else{
            noiseFloor = total/count + 15;
            listen();
        }
    }

    measure();
}

function bandEnergy(freq){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    const nyquist = audioCtx.sampleRate/2;
    const index = Math.round(freq/nyquist * buffer.length);

    let energy = 0;

    for(let i=index-4;i<=index+4;i++){
        if(buffer[i]) energy+=buffer[i];
    }

    return energy;
}

function listen(){

    if(!receiving){

        if(bandEnergy(START) > noiseFloor){
            receiving=true;
            finalText="";
            bufferBits="";
            setTimeout(readBit,250);
        }

    }

    requestAnimationFrame(listen);
}

function readBit(){

    if(!receiving) return;

    if(bandEnergy(END) > noiseFloor){
        receiving=false;
        return;
    }

    let e0 = bandEnergy(FREQ0);
    let e1 = bandEnergy(FREQ1);

    if(e0 < noiseFloor && e1 < noiseFloor){
        setTimeout(readBit,250);
        return;
    }

    let bit = e0 > e1 ? "0" : "1";

    bufferBits += bit;

    document.getElementById("affichage").innerText =
        finalText + " [" + bufferBits + "]";

    if(bufferBits.length === 8){

        if(bufferBits.startsWith(PREAMBLE)){
            bufferBits = bufferBits.slice(8);
        }
        else{
            finalText +=
                String.fromCharCode(parseInt(bufferBits,2));
            bufferBits="";
        }
    }

    setTimeout(readBit,250);
}

</script>
</body>
</html>
