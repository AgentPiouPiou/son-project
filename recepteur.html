<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Ultra Stable</title>
</head>
<body>

<h2>Récepteur Ultra Stable</h2>
<button onclick="start()">Démarrer (Calibration 3s)</button>

<p id="affichage"></p>

<script>

const BIT_DURATION = 250;
const FREQ0 = 1500;
const FREQ1 = 5000;
const START = 7000;
const END = 9000;

let audioCtx, analyser;
let noiseFloor = 0;

async function start(){

    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    source.connect(analyser);

    calibrate();
}

function calibrate(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    let total=0,count=0;
    const start = Date.now();

    function measure(){
        analyser.getByteFrequencyData(buffer);
        total += Math.max(...buffer);
        count++;
        if(Date.now()-start<3000){
            requestAnimationFrame(measure);
        } else {
            noiseFloor = total/count + 10;
            waitForStart();
        }
    }
    measure();
}

function getEnergy(targetFreq){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    const nyquist = audioCtx.sampleRate/2;
    const index = Math.round(targetFreq/nyquist * buffer.length);

    let energy = 0;
    for(let i=index-3;i<=index+3;i++){
        if(buffer[i]) energy += buffer[i];
    }
    return energy;
}

function waitForStart(){

    function check(){
        if(getEnergy(START)>noiseFloor){
            setTimeout(receive,1200);
            return;
        }
        requestAnimationFrame(check);
    }
    check();
}

function receive(){

    let finalText="";
    let bitBuffer="";

    const interval = setInterval(()=>{

        let e0 = getEnergy(FREQ0);
        let e1 = getEnergy(FREQ1);
        let eEnd = getEnergy(END);

        if(eEnd>noiseFloor){
            clearInterval(interval);
            return;
        }

        if(e0<noiseFloor && e1<noiseFloor){
            return;
        }

        let bit = e0>e1 ? "0" : "1";

        bitBuffer+=bit;

        document.getElementById("affichage").innerText =
            finalText + " ["+bitBuffer+"]";

        if(bitBuffer.length===8){
            let letter =
                String.fromCharCode(parseInt(bitBuffer,2));
            finalText+=letter;
            bitBuffer="";
        }

    },BIT_DURATION);

}

</script>
</body>
</html>
