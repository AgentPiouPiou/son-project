<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Stable V2</title>
<style>
canvas { border:1px solid black; margin-top:10px;}
</style>
</head>
<body>

<h2>Récepteur</h2>
<button onclick="start()">Démarrer (Calibration 3s)</button>

<p id="affichage"></p>

<canvas id="spectre" width="600" height="150"></canvas>

<script>

const FREQ0 = 3000;
const FREQ1 = 3800;
const START = 4500;
const END = 5000;

let audioCtx, analyser;
let noiseLevel = 0;

let receiving = false;
let currentBit = null;
let bitCount = 0;
let bitBuffer = "";
let firstCopy = null;
let finalText = "";

async function start(){

    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 4096;
    source.connect(analyser);

    calibrate();
}

function calibrate(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    let total=0,count=0;
    const startTime = Date.now();

    function measure(){
        analyser.getByteFrequencyData(buffer);
        total += Math.max(...buffer);
        count++;
        if(Date.now()-startTime < 3000){
            requestAnimationFrame(measure);
        } else {
            noiseLevel = total/count + 20;
            drawSpectrum();
            listen();
        }
    }
    measure();
}

function drawSpectrum(){
    const canvas = document.getElementById("spectre");
    const ctx = canvas.getContext("2d");
    const buffer = new Uint8Array(analyser.frequencyBinCount);

    function draw(){
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(buffer);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=0;i<buffer.length;i++){
            ctx.fillRect(i,canvas.height,2,-buffer[i]);
        }
    }
    draw();
}

function getFreq(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let max=0,index=0;
    for(let i=0;i<buffer.length;i++){
        if(buffer[i]>max){
            max=buffer[i];
            index=i;
        }
    }

    if(max<noiseLevel) return null;

    return index*audioCtx.sampleRate/analyser.fftSize;
}

function listen(){

    const freq = getFreq();

    if(!receiving){
        if(freq && Math.abs(freq-START)<200){
            receiving=true;
            finalText="";
            bitBuffer="";
            firstCopy=null;
        }
    }
    else{

        if(freq && Math.abs(freq-END)<200){
            receiving=false;
            currentBit=null;
        }

        let detectedBit=null;

        if(freq && Math.abs(freq-FREQ0)<150) detectedBit="0";
        if(freq && Math.abs(freq-FREQ1)<150) detectedBit="1";

        if(detectedBit!==null){

            if(currentBit===null){
                currentBit=detectedBit;
                bitCount=1;
            }
            else if(currentBit===detectedBit){
                bitCount++;
            }
            else{
                if(bitCount>5){ // stabilité minimum
                    processBit(currentBit);
                }
                currentBit=detectedBit;
                bitCount=1;
            }
        }
    }

    requestAnimationFrame(listen);
}

function processBit(bit){

    bitBuffer+=bit;

    document.getElementById("affichage").innerText =
        finalText + " ["+bitBuffer+"]";

    if(bitBuffer.length===8){

        if(firstCopy===null){
            firstCopy=bitBuffer;
            bitBuffer="";
        }
        else{
            if(firstCopy===bitBuffer){
                const letter =
                    String.fromCharCode(parseInt(bitBuffer,2));
                finalText+=letter;
            }
            firstCopy=null;
            bitBuffer="";
        }
    }
}

</script>
</body>
</html>
