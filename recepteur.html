<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur</title>
<style>
canvas { border:1px solid black; }
</style>
</head>
<body>

<h2>Récepteur</h2>

<button onclick="start()">Démarrer</button>

<p id="bits"></p>
<p id="texte"></p>

<canvas id="spectre" width="600" height="200"></canvas>

<script>

const BIT_DURATION = 150;
const FREQ0 = 3500;
const FREQ1 = 4200;
const START = 5000;
const END = 5500;

let audioCtx, analyser;
let receiving = false;
let currentBits = "";
let finalText = "";

async function start(){

    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);

    drawSpectrum();
    listen();
}

function drawSpectrum(){

    const canvas = document.getElementById("spectre");
    const ctx = canvas.getContext("2d");
    const buffer = new Uint8Array(analyser.frequencyBinCount);

    function draw(){
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(buffer);
        ctx.clearRect(0,0,canvas.width,canvas.height);

        for(let i=0;i<buffer.length;i++){
            ctx.fillRect(i, canvas.height, 2, -buffer[i]);
        }
    }

    draw();
}

function getFrequency(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let max = 0;
    let index = 0;

    for(let i=0;i<buffer.length;i++){
        if(buffer[i] > max){
            max = buffer[i];
            index = i;
        }
    }

    return index * audioCtx.sampleRate / analyser.fftSize;
}

function listen(){

    const freq = getFrequency();

    if(Math.abs(freq-START)<200){
        receiving = true;
        currentBits = "";
        finalText = "";
    }

    if(receiving){

        if(Math.abs(freq-FREQ0)<150){
            addBit("0");
        }
        else if(Math.abs(freq-FREQ1)<150){
            addBit("1");
        }

        if(Math.abs(freq-END)<200){
            receiving = false;
        }
    }

    requestAnimationFrame(listen);
}

function addBit(bit){

    currentBits += bit;
    document.getElementById("bits").innerText = currentBits;

    if(currentBits.length === 8){

        const letter =
            String.fromCharCode(parseInt(currentBits,2));

        finalText += letter;
        document.getElementById("texte").innerText = finalText;

        currentBits = "";
    }
}

</script>
</body>
</html>
