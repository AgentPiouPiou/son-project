<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>R√©cepteur d√©cimal</title>

<style>
body{
  font-family:Arial;
  max-width:800px;
  margin:auto;
}

canvas{
  width:100%;
  height:220px;
  border:1px solid #ccc;
}

.mono{
  font-family:monospace;
}
</style>
</head>

<body>

<h1>üéß R√©cepteur d√©cimal</h1>

<button onclick="start()">D√©marrer r√©ception</button>

<h3>Texte re√ßu en temps r√©el</h3>
<p id="liveText" class="mono"></p>

<h3>Spectre</h3>
<canvas id="viz"></canvas>

<script>

const audioCtx=new AudioContext();

const INIT_FREQ=300;

const SYMBOL_FREQS=[
500,700,900,1100,1300,
1500,1700,1900,2100,2300
];

let analyser;

/* ENERGY DETECTOR */

function energyAround(freq){

  const buffer=new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(buffer);

  const nyquist=audioCtx.sampleRate/2;

  const idx=Math.round((freq/nyquist)*buffer.length);

  let sum=0;
  let count=0;

  for(let i=idx-2;i<=idx+2;i++){
    if(buffer[i]){
      sum+=buffer[i];
      count++;
    }
  }

  return count?sum/count:0;
}

let messageBuffer="";
let lastSymbolTime=0;

function detectLoop(){

  const now=performance.now();

  if(now-lastSymbolTime>60){

    const initEnergy=energyAround(INIT_FREQ);

    if(initEnergy>110){
      messageBuffer="";
    }

    let best=-1;
    let bestIdx=-1;

    SYMBOL_FREQS.forEach((f,i)=>{

      const e=energyAround(f);

      if(e>best){
        best=e;
        bestIdx=i;
      }
    });

    if(best>120 && bestIdx>=0){
      messageBuffer+=bestIdx.toString();
      document.getElementById("liveText").textContent=messageBuffer;
      lastSymbolTime=now;
    }
  }

  requestAnimationFrame(detectLoop);
}

/* VISUALISATION */

function visualize(){

  const canvas=document.getElementById("viz");
  const ctx=canvas.getContext("2d");

  const buffer=new Uint8Array(analyser.frequencyBinCount);

  function draw(){

    analyser.getByteFrequencyData(buffer);

    ctx.fillStyle="white";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.beginPath();

    for(let i=0;i<buffer.length;i++){

      const x=i/buffer.length*canvas.width;
      const y=canvas.height-buffer[i];

      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }

    ctx.stroke();

    requestAnimationFrame(draw);
  }

  draw();
}

/* START */

async function start(){

  const stream=await navigator.mediaDevices.getUserMedia({
    audio:{
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  const source=audioCtx.createMediaStreamSource(stream);

  analyser=audioCtx.createAnalyser();
  analyser.fftSize=4096;
  analyser.smoothingTimeConstant=0.25;

  source.connect(analyser);

  detectLoop();
  visualize();
}

</script>
</body>
</html>
