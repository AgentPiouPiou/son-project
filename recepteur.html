<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Stable</title>
</head>
<body>

<h2>Récepteur Stable</h2>

<button onclick="demarrer()">Démarrer (calibration 3s)</button>
<button onclick="stopListening()">Stop</button>

<p id="status"></p>

<h3>Texte reçu :</h3>
<p id="texte"></p>

<script>

const FREQ_0 = 1200;
const FREQ_1 = 2200;
const FREQ_START = 3000;
const FREQ_END = 3500;
const BIT_DURATION = 200;

let audioCtx;
let analyser;
let stream;
let noiseLevel = 0;
let listening = false;
let receiving = false;
let bits = "";

async function demarrer(){

    document.getElementById("status").innerText =
        "Calibration bruit pendant 3 secondes...";

    stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);

    const buffer = new Uint8Array(analyser.frequencyBinCount);

    let total = 0;
    let count = 0;
    const start = Date.now();

    while(Date.now() - start < 3000){
        analyser.getByteFrequencyData(buffer);
        total += Math.max(...buffer);
        count++;
    }

    noiseLevel = total / count + 15;

    document.getElementById("status").innerText =
        "Prêt. En attente du signal START...";

    listening = true;
    loop();
}

function stopListening(){
    listening = false;
    if(stream){
        stream.getTracks().forEach(track => track.stop());
    }
    document.getElementById("status").innerText = "Arrêté";
}

function getDominant(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let maxIndex = 0;
    let maxValue = 0;

    for(let i=0;i<buffer.length;i++){
        if(buffer[i] > maxValue){
            maxValue = buffer[i];
            maxIndex = i;
        }
    }

    if(maxValue < noiseLevel) return null;

    return maxIndex * audioCtx.sampleRate / analyser.fftSize;
}

function loop(){

    if(!listening) return;

    const freq = getDominant();

    if(freq && !receiving && Math.abs(freq - FREQ_START) < 150){
        receiving = true;
        bits = "";
        setTimeout(readBits,500);
    }

    requestAnimationFrame(loop);
}

function readBits(){

    if(!receiving) return;

    const freq = getDominant();

    if(freq && Math.abs(freq - FREQ_END) < 150){
        receiving = false;
        decode();
        return;
    }

    if(freq){
        if(Math.abs(freq - FREQ_1) < 150){
            bits += "1";
        } else if(Math.abs(freq - FREQ_0) < 150){
            bits += "0";
        }
    }

    setTimeout(readBits, BIT_DURATION);
}

function decode(){

    let texte = "";

    for(let i=0;i<bits.length;i+=8){
        const byte = bits.slice(i,i+8);
        if(byte.length === 8){
            texte += String.fromCharCode(parseInt(byte,2));
        }
    }

    document.getElementById("texte").innerText = texte;
}

</script>
</body>
</html>
