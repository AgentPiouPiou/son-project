<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©cepteur binaire</title>

<style>
body{
    font-family:Arial;
    max-width:900px;
    margin:auto;
}

.mono{
    font-family:monospace;
    white-space:pre-wrap;
}

canvas{
    width:100%;
    height:220px;
}
</style>
</head>

<body>

<h1>ðŸŽ§ RÃ©cepteur binaire</h1>

<button onclick="start()">DÃ©marrer</button>

<h3>Texte reÃ§u</h3>
<p id="message" class="mono"></p>

<canvas id="viz"></canvas>

<script>

const audioCtx=new AudioContext();

const BIT_DURATION=0.035;

const FREQ0=1200;
const FREQ1=2400;

const PREAMBLE="10101011";

let analyser;

/* Energy */

function energyAround(freq){

    const buffer=new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    const nyquist=audioCtx.sampleRate/2;

    const idx=Math.round((freq/nyquist)*buffer.length);

    let sum=0,count=0;

    for(let i=idx-3;i<=idx+3;i++){
        if(buffer[i]){
            sum+=buffer[i];
            count++;
        }
    }

    return count?sum/count:0;
}

let bufferBits="";

/* Detection */

function detectLoop(){

    const e0=energyAround(FREQ0);
    const e1=energyAround(FREQ1);

    if(e0>120 || e1>120){
        bufferBits+= e1>e0 ? "1":"0";
    }

    document.getElementById("message").innerHTML=
        bufferBits;

    requestAnimationFrame(detectLoop);
}

/* Start mic */

async function start(){

    const stream=await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    const source=audioCtx.createMediaStreamSource(stream);

    analyser=audioCtx.createAnalyser();
    analyser.fftSize=4096;

    source.connect(analyser);

    detectLoop();
}

/* Visualization */

function visualize(){

    const canvas=document.getElementById("viz");
    const ctx=canvas.getContext("2d");

    const buffer=new Uint8Array(1024);

    function draw(){

        analyser.getByteFrequencyData(buffer);

        ctx.fillStyle="white";
        ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.beginPath();

        for(let i=0;i<buffer.length;i++){

            const x=i/buffer.length*canvas.width;
            const y=canvas.height-buffer[i];

            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }

        ctx.stroke();

        requestAnimationFrame(draw);
    }

    draw();
}

</script>

</body>
</html>
