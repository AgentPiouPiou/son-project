<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Sync</title>
</head>
<body>

<h2>Récepteur avec Synchronisation</h2>
<button onclick="start()">Démarrer</button>

<p id="affichage"></p>

<script>

const BIT_DURATION = 200;
const FREQ0 = 1200;
const FREQ1 = 2200;
const START = 3000;
const END = 3500;

const PREAMBLE = "11110000";

let audioCtx, analyser;
let receiving = false;
let bitStream = "";
let finalText = "";

async function start(){

    const stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);

    listen();
}

function getFreq(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let max=0,index=0;

    for(let i=0;i<buffer.length;i++){
        if(buffer[i]>max){
            max=buffer[i];
            index=i;
        }
    }

    return index * audioCtx.sampleRate / analyser.fftSize;
}

function listen(){

    const freq = getFreq();

    if(!receiving){
        if(Math.abs(freq-START)<200){
            receiving=true;
            finalText="";
            bitStream="";
            setTimeout(readBit,BIT_DURATION);
        }
    }

    requestAnimationFrame(listen);
}

function readBit(){

    if(!receiving) return;

    const freq = getFreq();

    if(Math.abs(freq-END)<200){
        receiving=false;
        return;
    }

    let bit=null;

    if(Math.abs(freq-FREQ0)<150) bit="0";
    else if(Math.abs(freq-FREQ1)<150) bit="1";

    if(bit){
        bitStream+=bit;

        document.getElementById("affichage").innerText =
            finalText + " ["+bitStream+"]";

        // Cherche le préambule
        if(bitStream.endsWith(PREAMBLE)){
            bitStream="";
        }

        // Quand on a 8 bits après préambule
        if(bitStream.length===8){
            finalText +=
                String.fromCharCode(parseInt(bitStream,2));
            bitStream="";
        }
    }

    setTimeout(readBit,BIT_DURATION);
}

</script>
</body>
</html>
