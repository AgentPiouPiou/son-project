<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Récepteur Stable</title>
</head>
<body>

<h2>Récepteur Stable</h2>

<button onclick="startListening()">Démarrer</button>
<button onclick="stopListening()">Stop</button>

<h3>Texte reçu :</h3>
<p id="texte"></p>

<script>

const FREQ_0 = 1200;
const FREQ_1 = 2200;
const FREQ_START = 3000;
const FREQ_END = 3500;
const BIT_DURATION = 200;

let audioCtx;
let analyser;
let stream;
let listening = false;
let receiving = false;
let bits = "";

async function startListening(){

    stream = await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;

    source.connect(analyser);

    listening = true;
    loop();
}

function stopListening(){
    listening = false;
    if(stream){
        stream.getTracks().forEach(track => track.stop());
    }
}

function getDominantFreq(){

    const buffer = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    let maxIndex = 0;
    let maxValue = 0;

    for(let i=0;i<buffer.length;i++){
        if(buffer[i] > maxValue){
            maxValue = buffer[i];
            maxIndex = i;
        }
    }

    return maxIndex * audioCtx.sampleRate / analyser.fftSize;
}

function loop(){

    if(!listening) return;

    const freq = getDominantFreq();

    if(!receiving && Math.abs(freq - FREQ_START) < 150){
        receiving = true;
        bits = "";
        setTimeout(readBits, 500);
    }

    requestAnimationFrame(loop);
}

function readBits(){

    if(!receiving) return;

    const freq = getDominantFreq();

    if(Math.abs(freq - FREQ_END) < 150){
        receiving = false;
        decode();
        return;
    }

    if(Math.abs(freq - FREQ_1) < 150){
        bits += "1";
    } else if(Math.abs(freq - FREQ_0) < 150){
        bits += "0";
    }

    setTimeout(readBits, BIT_DURATION);
}

function decode(){

    let texte = "";

    for(let i=0;i<bits.length;i+=8){
        const byte = bits.slice(i,i+8);
        if(byte.length === 8){
            texte += String.fromCharCode(parseInt(byte,2));
        }
    }

    document.getElementById("texte").innerText = texte;
}

</script>
</body>
</html>
