<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>RÃ©cepteur sonore</title>

<style>
body{
    font-family:Arial;
    max-width:900px;
    margin:auto;
}

canvas{
    width:100%;
    height:220px;
    border:1px solid #ccc;
}

.mono{
    font-family:monospace;
    white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>ðŸŽ§ RÃ©cepteur audio</h1>

<button onclick="start()">DÃ©marrer rÃ©ception</button>

<h3>Message reÃ§u progressivement</h3>

<p id="message" class="mono"></p>

<h3>Spectre</h3>
<canvas id="viz"></canvas>

<script>

const audioCtx=new AudioContext();

const FREQUENCIES=[
800,1200,1600,2000,2400,2800,3200,4000
];

let analyser;

/* Detection Ã©nergie */

function energyAround(freq){

    const buffer=new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buffer);

    const nyquist=audioCtx.sampleRate/2;

    const idx=Math.round((freq/nyquist)*buffer.length);

    let sum=0,count=0;

    for(let i=idx-3;i<=idx+3;i++){
        if(buffer[i]){
            sum+=buffer[i];
            count++;
        }
    }

    return count?sum/count:0;
}

let bufferMessage="";
let lastSymbolTime=0;

/* Detection loop */

function detectLoop(){

    let best=-1;
    let bestIdx=-1;

    FREQUENCIES.forEach((f,i)=>{

        const e=energyAround(f);

        if(e>best){
            best=e;
            bestIdx=i;
        }
    });

    if(best>120 && bestIdx>=0){

        const letter=
            String.fromCharCode(
                bestIdx + "A".charCodeAt(0)
            );

        bufferMessage+=letter;

        document.getElementById("message").innerHTML=
            bufferMessage;

        lastSymbolTime=performance.now();
    }

    requestAnimationFrame(detectLoop);
}

/* Visualisation */

function visualize(){

    const canvas=document.getElementById("viz");
    const ctx=canvas.getContext("2d");

    const buffer=new Uint8Array(analyser.frequencyBinCount);

    function draw(){

        analyser.getByteFrequencyData(buffer);

        ctx.fillStyle="white";
        ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.beginPath();

        for(let i=0;i<buffer.length;i++){

            const x=i/buffer.length*canvas.width;
            const y=canvas.height-buffer[i];

            if(i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
        }

        ctx.stroke();

        requestAnimationFrame(draw);
    }

    draw();
}

/* Start microphone */

async function start(){

    const stream=await navigator.mediaDevices.getUserMedia({
        audio:{
            echoCancellation:false,
            noiseSuppression:false,
            autoGainControl:false
        }
    });

    const source=audioCtx.createMediaStreamSource(stream);

    analyser=audioCtx.createAnalyser();
    analyser.fftSize=4096;
    analyser.smoothingTimeConstant=0.25;

    source.connect(analyser);

    detectLoop();
    visualize();
}

</script>
</body>
</html>