<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<title>Ã‰metteur Ultrasonique Stable</title>

<style>
body{
  font-family:Arial;
  max-width:900px;
  margin:auto;
}

textarea{
  width:100%;
  min-height:100px;
}

canvas{
  width:100%;
  height:200px;
  border:1px solid #ccc;
}

.mono{
  font-family:monospace;
}
</style>
</head>

<body>

<h1>ðŸ”Š Ã‰metteur Ultrasonique</h1>

<textarea id="texte"></textarea>

<br><br>

<button onclick="send()">Envoyer</button>

<h3>Visualisation Ã©mission</h3>
<canvas id="vizTx"></canvas>

<p id="etat" class="mono"></p>

<script>

/* -------- CONFIG -------- */

const audioCtx=new AudioContext();

const SYMBOL_FREQS=[
15000,16000,17000,18000,19000
];

const INIT_FREQ=14000;

const SYMBOL_DURATION=0.04;
const GAP=0.01;

/* -------- AUDIO -------- */

function tone(freq,start,dur,gain=0.2){

    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();

    osc.frequency.value=freq;
    osc.type="sine";

    g.gain.setValueAtTime(0.00001,start);
    g.gain.linearRampToValueAtTime(gain,start+0.005);
    g.gain.linearRampToValueAtTime(0.00001,start+dur);

    osc.connect(g);
    g.connect(audioCtx.destination);

    osc.start(start);
    osc.stop(start+dur);
}

/* -------- ENCODING -------- */

function encodeDecimal(text){

    return text
        .split("")
        .map(c=>parseInt(c))
        .filter(n=>!isNaN(n));
}

/* -------- VISUAL -------- */

function drawEmitter(freq){

    const canvas=document.getElementById("vizTx");
    const ctx=canvas.getContext("2d");

    ctx.fillStyle="white";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="black";
    ctx.fillText("Emission: "+freq+" Hz",10,20);
}

/* -------- SEND -------- */

async function send(){

    await audioCtx.resume();

    const text=document.getElementById("texte").value;

    const symbols=encodeDecimal(text);

    let t=audioCtx.currentTime+0.1;

    /* INIT */
    tone(INIT_FREQ,t,0.8,0.25);

    t+=1.0;

    for(const s of symbols){

        const freq=SYMBOL_FREQS[s];

        if(!freq) continue;

        tone(freq,t,SYMBOL_DURATION,0.2);

        drawEmitter(freq);

        t+=SYMBOL_DURATION+GAP;
    }

    document.getElementById("etat").textContent=
    "Transmission lancÃ©e";
}

</script>

</body>
</html>
