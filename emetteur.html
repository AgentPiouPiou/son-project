<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Émetteur Avancé</title>
</head>
<body>

<h2>Émetteur Avancé</h2>

<input id="texte" placeholder="Tape ton texte">
<button onclick="envoyer()">Envoyer</button>

<p id="info"></p>

<script>

const BIT_DURATION = 0.11;

const FREQ = {
  "00": 3200,
  "01": 3600,
  "10": 4000,
  "11": 4400
};

const START = 5000;
const END = 5500;

function textToBinary(text){
    return text.split('')
        .map(c => c.charCodeAt(0).toString(2).padStart(8,'0'))
        .join('');
}

function crc8(binary){
    let crc = 0;
    for(let i=0;i<binary.length;i++){
        crc ^= parseInt(binary[i]);
    }
    return crc.toString(2).padStart(8,"0");
}

async function envoyer(){

    const texte = document.getElementById("texte").value;
    let binary = textToBinary(texte);

    const crc = crc8(binary);
    binary += crc;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let time = audioCtx.currentTime;

    function tone(freq, dur){
        const osc = audioCtx.createOscillator();
        osc.frequency.value = freq;
        osc.connect(audioCtx.destination);
        osc.start(time);
        osc.stop(time + dur);
        time += dur;
    }

    document.getElementById("info").innerText =
        "Transmission...";

    tone(START, 1);

    for(let i=0;i<binary.length;i+=2){

        const bits = binary.slice(i,i+2);
        const freq = FREQ[bits];

        tone(freq, BIT_DURATION);
        tone(freq, BIT_DURATION); // répétition
    }

    tone(END, 1);

    document.getElementById("info").innerText =
        "Terminé";
}

</script>
</body>
</html>