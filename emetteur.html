<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>√âmetteur sonore</title>

<style>
body{
    font-family:Arial;
    max-width:900px;
    margin:auto;
}

textarea{
    width:100%;
    min-height:120px;
}

.bold{
    font-weight:bold;
    font-size:1.2em;
}

.mono{
    font-family:monospace;
}
</style>
</head>

<body>

<h1>üîä √âmetteur audio</h1>

<textarea id="texte"></textarea>

<br><br>

<button onclick="send()">Envoyer</button>

<h3>Information transmission</h3>

<p id="info" class="mono"></p>

<h3>Caract√®re envoy√© en temps r√©el</h3>

<p id="currentChar" class="bold"></p>

<script>

const audioCtx=new AudioContext();

/* Fr√©quences tr√®s s√©par√©es pour stabilit√© */
const FREQUENCIES=[
800,
1200,
1600,
2000,
2400,
2800,
3200,
4000
];

const SYMBOL_DURATION=0.06;
const GAP=0.015;
const INIT_FREQ=600;

/* Tone generator */

function tone(freq,start,dur,gain=0.22){

    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();

    osc.frequency.value=freq;
    osc.type="sine";

    g.gain.setValueAtTime(0.00001,start);
    g.gain.linearRampToValueAtTime(gain,start+0.005);
    g.gain.linearRampToValueAtTime(0.00001,start+dur);

    osc.connect(g);
    g.connect(audioCtx.destination);

    osc.start(start);
    osc.stop(start+dur);
}

/* Transmission */

async function send(){

    await audioCtx.resume();

    const text=document.getElementById("texte").value;

    if(!text.trim()) return;

    let chars=text.split("");

    let totalTimeEstimate=
        0.8 + 1.0 + chars.length*(SYMBOL_DURATION+GAP);

    document.getElementById("info").innerHTML=
        "Texte longueur : "+chars.length+"<br>"+
        "Temps total estim√© : "+totalTimeEstimate.toFixed(2)+" s<br>"+
        "Temps restant dynamique affich√© pendant √©mission";

    let t=audioCtx.currentTime+0.1;

    tone(INIT_FREQ,t,0.8);

    t+=1.0;

    let index=0;

    function transmitNext(){

        if(index>=chars.length) return;

        let char=chars[index];

        document.getElementById("currentChar").innerHTML=
            "Envoi : <b>"+char+"</b>";

        let code=char.charCodeAt(0)%FREQUENCIES.length;

        tone(FREQUENCIES[code],t,SYMBOL_DURATION);

        let elapsed=index*(SYMBOL_DURATION+GAP);

        let remaining=
            totalTimeEstimate-elapsed;

        document.getElementById("info").innerHTML=
            "Transmission en cours<br>"+
            "Caract√®re "+(index+1)+"/"+chars.length+"<br>"+
            "Temps restant ‚âà "+remaining.toFixed(2)+" s";

        index++;

        t+=SYMBOL_DURATION+GAP;

        setTimeout(transmitNext,SYMBOL_DURATION*1000);
    }

    transmitNext();
}

</script>

</body>
</html>
