<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ã‰metteur binaire</title>

<style>
body{
    font-family:Arial;
    max-width:900px;
    margin:auto;
}

textarea{
    width:100%;
    min-height:120px;
}

.bold{
    font-weight:bold;
}
</style>
</head>

<body>

<h1>ðŸ”Š Ã‰metteur binaire</h1>

<textarea id="texte"></textarea>

<br><br>

<button onclick="send()">Envoyer</button>

<h3>Envoi en temps rÃ©el</h3>
<p id="currentChar" class="bold"></p>

<p id="info"></p>

<script>

const audioCtx=new AudioContext();

/* Protocol */

const BIT_DURATION=0.035;
const GAP=0.005;

const FREQ0=1200;
const FREQ1=2400;

const START_FREQ=800;
const END_FREQ=3000;

const PREAMBLE="10101011";

/* Tone */

function tone(freq,start,dur){

    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();

    osc.frequency.value=freq;
    osc.type="sine";

    gain.gain.setValueAtTime(0.00001,start);
    gain.gain.linearRampToValueAtTime(0.2,start+0.003);
    gain.gain.linearRampToValueAtTime(0.00001,start+dur);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(start);
    osc.stop(start+dur);
}

/* Encode */

function textToBinary(text){

    return Array.from(
        new TextEncoder().encode(text)
    ).map(b=>b.toString(2).padStart(8,"0")).join("");
}

/* Send */

async function send(){

    await audioCtx.resume();

    const text=document.getElementById("texte").value;

    if(!text.trim()) return;

    const payload=textToBinary(text);

    const frame=
        PREAMBLE +
        payload.length.toString(2).padStart(16,"0") +
        payload;

    let t=audioCtx.currentTime+0.1;

    tone(START_FREQ,t,0.8);

    t+=1.0;

    let index=0;

    function transmit(){

        if(index>=frame.length) return;

        const bit=frame[index];

        document.getElementById("currentChar").innerHTML=
            "Bit envoyÃ© : <b>"+bit+"</b>";

        tone(
            bit==="0"?FREQ0:FREQ1,
            t,
            BIT_DURATION
        );

        index++;
        t+=BIT_DURATION+GAP;

        setTimeout(transmit,BIT_DURATION*1000);
    }

    transmit();
}

</script>
</body>
</html>
