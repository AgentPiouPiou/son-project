<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<title>Ã‰metteur Temps RÃ©el DÃ©cimal</title>

<style>
body{
  font-family:Arial;
  max-width:900px;
  margin:auto;
}

canvas{
  width:100%;
  height:220px;
  border:1px solid #ccc;
}

textarea{
  width:100%;
  min-height:90px;
}

.mono{
  font-family:monospace;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>ðŸ”Š Ã‰metteur dÃ©cimal ultrasonique</h1>

<textarea id="texte"></textarea>

<br><br>

<button onclick="send()">Envoyer</button>

<h3>Visualisation Ã©mission</h3>
<canvas id="vizTx"></canvas>

<p id="etat" class="mono"></p>

<script>

const audioCtx=new AudioContext();

const SYMBOL_FREQS=[
15000,16000,17000,18000,19000,
20000,21000,22000,23000,24000
];

const INIT_FREQ=14000;

const SYMBOL_DURATION=0.04;
const GAP=0.01;

/* ---------------- VISUALISATION ---------------- */

const canvas=document.getElementById("vizTx");
const ctx=canvas.getContext("2d");

function drawEmitter(freq,time){

  const w=canvas.width;
  const h=canvas.height;

  ctx.fillStyle="white";
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle="black";

  ctx.fillText("Emission planifiÃ©e",10,20);

}

/* ---------------- AUDIO ---------------- */

function tone(freq,start,dur,gain=0.2){

  const osc=audioCtx.createOscillator();
  const g=audioCtx.createGain();

  osc.frequency.value=freq;
  osc.type="sine";

  g.gain.setValueAtTime(0.00001,start);
  g.gain.linearRampToValueAtTime(gain,start+0.005);
  g.gain.linearRampToValueAtTime(0.00001,start+dur);

  osc.connect(g);
  g.connect(audioCtx.destination);

  osc.start(start);
  osc.stop(start+dur);
}

/* ---------------- ENCODING ---------------- */

function encodeDecimal(text){

  return text
    .split("")
    .map(c=>parseInt(c))
    .filter(n=>!isNaN(n));
}

async function send(){

  await audioCtx.resume();

  const text=document.getElementById("texte").value;

  const symbols=encodeDecimal(text);

  let t=audioCtx.currentTime+0.1;

  /* INIT TONE */
  tone(INIT_FREQ,t,0.8,0.25);

  t+=1.0;

  for(const s of symbols){

    const freq=SYMBOL_FREQS[s];

    tone(freq,t,SYMBOL_DURATION,0.2);

    drawEmitter(freq,t);

    t+=SYMBOL_DURATION+GAP;
  }

  document.getElementById("etat").textContent=
  "Transmission lancÃ©e";
}

</script>

</body>
</html>
