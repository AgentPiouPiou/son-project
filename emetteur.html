<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>√âmetteur sonore</title>

<style>
body{
    font-family:Arial;
    max-width:900px;
    margin:auto;
}

textarea{
    width:100%;
    min-height:120px;
}

.bold{
    font-weight:bold;
    font-size:1.2em;
}

.mono{
    font-family:monospace;
}
</style>
</head>

<body>

<h1>üîä √âmetteur audio</h1>

<textarea id="texte"></textarea>

<br><br>

<button onclick="send()">Envoyer</button>

<h3>Caract√®re envoy√© en temps r√©el</h3>
<p id="currentChar" class="bold"></p>

<h3>Information transmission</h3>
<p id="info" class="mono"></p>

<script>

const audioCtx=new AudioContext();

/* Fr√©quences distinctes */
const FREQUENCIES=[
800,1200,1600,2000,2400,2800,3200,4000
];

const SYMBOL_DURATION=0.06;
const GAP=0.015;
const INIT_FREQ=600;

/* Tone generator */

function tone(freq,start,dur,gain=0.22){

    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();

    osc.frequency.value=freq;
    osc.type="sine";

    g.gain.setValueAtTime(0.00001,start);
    g.gain.linearRampToValueAtTime(gain,start+0.005);
    g.gain.linearRampToValueAtTime(0.00001,start+dur);

    osc.connect(g);
    g.connect(audioCtx.destination);

    osc.start(start);
    osc.stop(start+dur);
}

/* Transmission */

async function send(){

    await audioCtx.resume();

    const text=document.getElementById("texte").value;

    if(!text.trim()) return;

    const chars=text.split("");

    const totalTime=
        0.8 + 1.0 + chars.length*(SYMBOL_DURATION+GAP);

    const startTime=audioCtx.currentTime+0.1;

    /* START tone */
    tone(INIT_FREQ,startTime,0.8);

    let symbolStart=startTime+0.8+0.2;

    let index=0;

    function renderUI(){

        let elapsed=audioCtx.currentTime-startTime;
        let remaining=Math.max(0,totalTime-elapsed);

        if(index<chars.length){
            document.getElementById("currentChar").innerHTML=
                "Envoi : <b>"+chars[index]+"</b>";
        }

        document.getElementById("info").innerHTML=
            "Transmission en cours<br>"+
            "Caract√®re "+(index+1)+"/"+chars.length+"<br>"+
            "Temps restant ‚âà "+remaining.toFixed(2)+" s";

        if(elapsed<totalTime){
            requestAnimationFrame(renderUI);
        }
    }

    renderUI();

    function transmitNext(){

        if(index>=chars.length) return;

        const char=chars[index];

        const code=char.charCodeAt(0)%FREQUENCIES.length;

        tone(FREQUENCIES[code],symbolStart,
             SYMBOL_DURATION);

        index++;

        symbolStart+=SYMBOL_DURATION+GAP;

        setTimeout(transmitNext,SYMBOL_DURATION*1000);
    }

    setTimeout(transmitNext,1000);
}

</script>

</body>
</html>
