<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Émetteur</title>
<style>
canvas { border:1px solid black; }
.bold { font-weight:bold; color:red; }
</style>
</head>
<body>

<h2>Émetteur</h2>

<input id="texte" placeholder="Tape ton texte">
<button onclick="envoyer()">Envoyer</button>

<p id="affichage"></p>
<p id="binaire"></p>

<canvas id="spectre" width="600" height="200"></canvas>

<script>

const BIT_DURATION = 0.15;
const FREQ0 = 3500;
const FREQ1 = 4200;
const START = 5000;
const END = 5500;

let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;

let sourceNode = audioCtx.createMediaStreamSource(
    new MediaStream()
);

function drawSpectrum(){

    const canvas = document.getElementById("spectre");
    const ctx = canvas.getContext("2d");
    const buffer = new Uint8Array(analyser.frequencyBinCount);

    function draw(){
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(buffer);
        ctx.clearRect(0,0,canvas.width,canvas.height);

        for(let i=0;i<buffer.length;i++){
            const value = buffer[i];
            ctx.fillRect(i, canvas.height, 2, -value);
        }
    }

    draw();
}

drawSpectrum();

function textToBinary(text){
    return text.split('')
        .map(c => c.charCodeAt(0).toString(2).padStart(8,'0'));
}

async function envoyer(){

    const texte = document.getElementById("texte").value;
    const binaryArray = textToBinary(texte);

    let time = audioCtx.currentTime;

    function tone(freq, dur){
        const osc = audioCtx.createOscillator();
        osc.frequency.value = freq;
        osc.connect(analyser);
        analyser.connect(audioCtx.destination);
        osc.start(time);
        osc.stop(time + dur);
        time += dur;
    }

    tone(START, 0.8);

    for(let i=0;i<binaryArray.length;i++){

        const lettres = texte.split('');
        document.getElementById("affichage").innerHTML =
            lettres.map((l,index)=>
                index===i ? `<span class="bold">${l}</span>` : l
            ).join('');

        document.getElementById("binaire").innerText =
            binaryArray[i];

        for(let bit of binaryArray[i]){
            tone(bit==="0"?FREQ0:FREQ1, BIT_DURATION);
        }
    }

    tone(END, 0.8);
}

</script>
</body>
</html>
